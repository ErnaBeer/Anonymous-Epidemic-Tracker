<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Epidemic Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            border: 1px solid rgba(44, 83, 100, 0.2);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .card h2 {
            color: #0f2027;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 3px solid #00d4ff;
            padding-bottom: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            background: linear-gradient(135deg, #e0f7ff 0%, #f0f9ff 100%);
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #00d4ff;
            box-shadow: 0 4px 10px rgba(0, 212, 255, 0.1);
        }

        .status-label {
            font-weight: bold;
            color: #2c5364;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #0f2027;
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.5);
            background: linear-gradient(135deg, #0099cc 0%, #00d4ff 100%);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.5);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.5);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .scale-info {
            background: linear-gradient(135deg, #e0f7ff 0%, #f0f9ff 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 10px 0;
            border-left: 5px solid #00d4ff;
            box-shadow: 0 4px 10px rgba(0, 212, 255, 0.1);
        }

        .scale-info h4 {
            color: #0f2027;
            margin-bottom: 10px;
        }

        .scale-info ul {
            margin-left: 20px;
        }

        .scale-info li {
            margin: 5px 0;
        }

        .network-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 1000;
        }

        .network-connected {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
        }

        .network-disconnected {
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0099cc, #00ff88);
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="network-status" id="networkStatus">Disconnected</div>

    <div class="container">
        <div class="header">
            <h1>üè• Anonymous Epidemic Tracker</h1>
            <p>Privacy-Preserving Health Monitoring System</p>
        </div>

        <!-- Connection Status -->
        <div class="card">
            <h2>üì° Connection Status</h2>
            <div id="connectionStatus">
                <div class="alert alert-warning">
                    Please connect your wallet to interact with the system
                </div>
                <button class="btn" onclick="connectWallet()">Connect Wallet</button>
            </div>
        </div>

        <!-- Current Period Status -->
        <div class="card">
            <h2>üìä Current Period Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Period Number</div>
                    <div class="status-value" id="currentPeriod">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Period Active</div>
                    <div class="status-value" id="periodActive">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Participants</div>
                    <div class="status-value" id="participantCount">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Time Remaining</div>
                    <div class="status-value" id="timeRemaining">-</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="periodProgress" style="width: 0%"></div>
            </div>
            <button class="btn" onclick="loadPeriodStatus()">Refresh Status</button>
        </div>

        <!-- Health Authority Functions -->
        <div class="card" id="authorityCard" style="display: none;">
            <h2>üèõÔ∏è Health Authority Functions</h2>
            <div class="form-grid">
                <div>
                    <h3>Period Management</h3>
                    <button class="btn btn-secondary" onclick="startNewPeriod()">Start New Period</button>
                    <button class="btn btn-danger" onclick="emergencyEndPeriod()">Emergency End Period</button>
                    <button class="btn" onclick="analyzePeriod()">Analyze Current Period</button>
                </div>
                <div>
                    <h3>Reporter Management</h3>
                    <div class="form-group">
                        <label for="reporterAddress">Reporter Address:</label>
                        <input type="text" id="reporterAddress" placeholder="0x...">
                    </div>
                    <button class="btn btn-secondary" onclick="authorizeReporter()">Authorize Reporter</button>
                    <button class="btn btn-danger" onclick="revokeReporter()">Revoke Reporter</button>
                </div>
                <div>
                    <h3>Alert Thresholds</h3>
                    <div class="form-group">
                        <label for="symptomThreshold">Symptom Alert Threshold:</label>
                        <input type="number" id="symptomThreshold" value="50" min="0">
                    </div>
                    <div class="form-group">
                        <label for="exposureThreshold">Exposure Alert Threshold:</label>
                        <input type="number" id="exposureThreshold" value="30" min="0">
                    </div>
                    <button class="btn" onclick="updateThresholds()">Update Thresholds</button>
                </div>
            </div>
        </div>

        <!-- Health Report Submission -->
        <div class="card" id="reportCard">
            <h2>üìù Submit Health Report</h2>

            <div class="scale-info">
                <h4>üìä Reporting Scales</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <strong>Symptom Score (0-10):</strong>
                        <ul>
                            <li>0-2: No symptoms</li>
                            <li>3-4: Mild symptoms (slight cough, fatigue)</li>
                            <li>5-6: Moderate symptoms (fever, persistent cough)</li>
                            <li>7-8: Severe symptoms (high fever, breathing difficulty)</li>
                            <li>9-10: Critical symptoms (hospitalization needed)</li>
                        </ul>
                    </div>
                    <div>
                        <strong>Exposure Level (0-5):</strong>
                        <ul>
                            <li>0: No known exposure</li>
                            <li>1: Minimal contact (outdoor, distant)</li>
                            <li>2: Brief contact (masked, ventilated area)</li>
                            <li>3: Moderate contact (unmasked, brief indoor)</li>
                            <li>4: High contact (prolonged indoor, unmasked)</li>
                            <li>5: Direct contact (close/intimate contact)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="symptomScore">Symptom Score (0-10):</label>
                    <select id="symptomScore">
                        <option value="">Select symptom severity</option>
                        <option value="0">0 - No symptoms</option>
                        <option value="1">1 - Very mild</option>
                        <option value="2">2 - Mild</option>
                        <option value="3">3 - Mild-moderate</option>
                        <option value="4">4 - Moderate</option>
                        <option value="5">5 - Moderate-severe</option>
                        <option value="6">6 - Severe</option>
                        <option value="7">7 - Very severe</option>
                        <option value="8">8 - Critical</option>
                        <option value="9">9 - Emergency</option>
                        <option value="10">10 - Life-threatening</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="exposureLevel">Exposure Level (0-5):</label>
                    <select id="exposureLevel">
                        <option value="">Select exposure risk</option>
                        <option value="0">0 - No known exposure</option>
                        <option value="1">1 - Minimal contact</option>
                        <option value="2">2 - Brief contact</option>
                        <option value="3">3 - Moderate contact</option>
                        <option value="4">4 - High contact</option>
                        <option value="5">5 - Direct contact</option>
                    </select>
                </div>
            </div>

            <div id="reportStatus"></div>
            <button class="btn" onclick="submitHealthReport()">Submit Anonymous Report</button>
        </div>

        <!-- Event Log -->
        <div class="card">
            <h2>üìã Event Log</h2>
            <div id="eventLog" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <p style="color: #666; font-style: italic;">Events will appear here...</p>
            </div>
            <button class="btn" onclick="clearEventLog()">Clear Log</button>
        </div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0x9dc12B91B6DdB12d6832CA7714AE6f3c06Fc7028'
        const CONTRACT_ABI = [
            "function healthAuthority() view returns (address)",
            "function currentPeriod() view returns (uint8)",
            "function authorizedReporters(address) view returns (bool)",
            "function isPeriodActive() view returns (bool)",
            "function shouldAnalyzePeriod() view returns (bool)",
            "function getCurrentPeriodInfo() view returns (uint8 period, bool active, bool ended, uint256 startTime, uint16 participantCount, uint256 timeRemaining)",
            "function hasUserReported(address user) view returns (bool reported, uint256 timestamp)",
            "function authorizeReporter(address reporter)",
            "function revokeReporter(address reporter)",
            "function startNewPeriod()",
            "function submitHealthReport(uint8 _symptomScore, uint8 _exposureLevel)",
            "function analyzePeriod()",
            "function emergencyEndPeriod()",
            "function updateThresholds(uint16 _symptomThreshold, uint16 _exposureThreshold)",
            "event PeriodStarted(uint8 indexed period, uint256 startTime)",
            "event HealthReportSubmitted(address indexed reporter, uint8 indexed period)",
            "event PeriodAnalyzed(uint8 indexed period, bool symptomAlert, bool exposureAlert)",
            "event AlertTriggered(uint8 indexed period, string alertType, uint16 aggregatedValue)",
            "event ReporterAuthorized(address indexed reporter)",
            "event ReporterRevoked(address indexed reporter)"
        ]

        // Global variables
        let provider = null
        let signer = null
        let contract = null
        let userAddress = null
        let isHealthAuthority = false

        // Initialize the application
        async function init() {
            try {
                addToEventLog('üöÄ Application starting...', 'info')

                // Check if ethers is loaded
                if (typeof ethers === 'undefined') {
                    addToEventLog('‚ùå Ethers.js library not loaded. Please refresh the page.', 'danger')
                    return
                }

                addToEventLog('‚úÖ Ethers.js library loaded', 'success')

                // Wait for MetaMask to be ready
                await waitForMetaMask()

                if (typeof window.ethereum !== 'undefined') {
                    try {
                        provider = new ethers.providers.Web3Provider(window.ethereum)
                        updateNetworkStatus(true)
                        addToEventLog('‚úÖ MetaMask detected', 'success')

                        // Listen for account changes
                        window.ethereum.on('accountsChanged', handleAccountsChanged)
                        window.ethereum.on('chainChanged', handleChainChanged)

                    } catch (providerError) {
                        addToEventLog('‚ö†Ô∏è Error setting up provider. Please refresh the page.', 'warning')
                    }
                } else {
                    updateNetworkStatus(false)
                    addToEventLog('‚ùå MetaMask not found. Please install MetaMask extension.', 'danger')
                    addToEventLog('üí° You can still explore the interface in demo mode', 'info')
                    setupDemoMode()
                }

                // Setup contract if address is provided
                if (CONTRACT_ADDRESS && CONTRACT_ADDRESS !== '0x...') {
                    if (provider) {
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider)
                        addToEventLog('üìã Contract interface ready', 'success')

                        // Setup event listeners
                        setupEventListeners()
                    }
                } else {
                    addToEventLog('‚ö†Ô∏è Demo mode - Please set CONTRACT_ADDRESS for full functionality', 'warning')
                }

            } catch (error) {
                console.error('Initialization error:', error)
                addToEventLog(`‚ùå Initialization error: ${error.message}`, 'danger')
            }
        }

        // Wait for MetaMask to be ready
        async function waitForMetaMask() {
            return new Promise((resolve) => {
                if (typeof window.ethereum !== 'undefined') {
                    resolve()
                } else {
                    // Wait up to 3 seconds for MetaMask to load
                    let attempts = 0
                    const checkInterval = setInterval(() => {
                        attempts++
                        if (typeof window.ethereum !== 'undefined' || attempts > 30) {
                            clearInterval(checkInterval)
                            resolve()
                        }
                    }, 100)
                }
            })
        }

        // Handle account changes
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                addToEventLog('üì± MetaMask disconnected', 'warning')
                disconnectWallet()
            } else {
                addToEventLog('üì± Account changed - please reconnect', 'info')
                if (userAddress) {
                    connectWallet()
                }
            }
        }

        // Handle chain changes
        function handleChainChanged(chainId) {
            addToEventLog(`üîó Network changed to Chain ID: ${parseInt(chainId, 16)}`, 'info')
            window.location.reload()
        }

        // Connect wallet
        async function connectWallet() {
            try {
                addToEventLog('üîó Connecting wallet...', 'info')

                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    addToEventLog('‚ùå MetaMask not detected. Please install MetaMask browser extension.', 'danger')
                    window.open('https://metamask.io/download/', '_blank')
                    return
                }

                // Re-initialize provider in case it wasn't ready before
                if (!provider) {
                    provider = new ethers.providers.Web3Provider(window.ethereum)
                    addToEventLog('üîÑ Provider re-initialized', 'info')
                }

                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                })

                if (accounts.length === 0) {
                    addToEventLog('‚ùå No accounts found. Please unlock MetaMask.', 'danger')
                    return
                }

                signer = provider.getSigner()
                userAddress = await signer.getAddress()

                addToEventLog(`‚úÖ Connected as ${userAddress.substring(0, 10)}...`, 'success')

                // Check network
                const network = await provider.getNetwork()
                addToEventLog(`üåê Connected to network: ${network.name} (Chain ID: ${network.chainId})`, 'info')

                if (contract && CONTRACT_ADDRESS !== '0x...') {
                    try {
                        contract = contract.connect(signer)

                        // Check if user is health authority
                        const healthAuthority = await contract.healthAuthority()
                        isHealthAuthority = userAddress.toLowerCase() === healthAuthority.toLowerCase()

                        // Check if user is authorized reporter
                        const isAuthorized = await contract.authorizedReporters(userAddress)

                        updateConnectionStatus(true, isAuthorized)

                        if (isHealthAuthority) {
                            addToEventLog('üëë Health Authority privileges detected', 'info')
                            document.getElementById('authorityCard').style.display = 'block'
                        }

                        await loadPeriodStatus()
                        await checkUserReportStatus()

                    } catch (contractError) {
                        addToEventLog('‚ö†Ô∏è Contract interaction error. Please check contract address and network.', 'warning')
                        updateConnectionStatus(true, false)
                    }
                } else {
                    updateConnectionStatus(true, false)
                    addToEventLog('‚ö†Ô∏è Contract not configured. Please set CONTRACT_ADDRESS.', 'warning')
                }

            } catch (error) {
                console.error('Connection error:', error)

                if (error.code === 4001) {
                    addToEventLog('‚ùå Connection rejected by user', 'danger')
                } else if (error.code === -32002) {
                    addToEventLog('‚ùå Connection request already pending. Please check MetaMask.', 'danger')
                } else {
                    addToEventLog(`‚ùå Connection failed: ${error.message}`, 'danger')
                }
            }
        }

        // Update connection status
        function updateConnectionStatus(connected, authorized = false) {
            const statusDiv = document.getElementById('connectionStatus')

            if (connected) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ Wallet connected: ${userAddress.substring(0, 10)}...
                        ${authorized ? '<br>üîì Authorized for reporting' : '<br>üîí Not authorized for reporting'}
                        ${isHealthAuthority ? '<br>üëë Health Authority' : ''}
                    </div>
                    <button class="btn btn-danger" onclick="disconnectWallet()">Disconnect</button>
                `
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        Please connect your wallet to interact with the system
                    </div>
                    <button class="btn" onclick="connectWallet()">Connect Wallet</button>
                `
            }
        }

        // Update network status indicator
        function updateNetworkStatus(connected) {
            const statusElement = document.getElementById('networkStatus')
            if (connected) {
                statusElement.textContent = 'Connected'
                statusElement.className = 'network-status network-connected'
            } else {
                statusElement.textContent = 'Disconnected'
                statusElement.className = 'network-status network-disconnected'
            }
        }

        // Load period status
        async function loadPeriodStatus() {
            try {
                if (!contract) {
                    addToEventLog('‚ùå Contract not connected', 'danger')
                    return
                }

                addToEventLog('üìä Loading period status...', 'info')

                const periodInfo = await contract.getCurrentPeriodInfo()
                const [period, active, ended, startTime, participantCount, timeRemaining] = periodInfo

                document.getElementById('currentPeriod').textContent = period.toString()
                document.getElementById('periodActive').textContent = active ? '‚úÖ Yes' : '‚ùå No'
                document.getElementById('participantCount').textContent = participantCount.toString()

                // Format time remaining
                const timeRemainingSeconds = timeRemaining.toNumber()
                const hours = Math.floor(timeRemainingSeconds / 3600)
                const minutes = Math.floor((timeRemainingSeconds % 3600) / 60)
                document.getElementById('timeRemaining').textContent =
                    timeRemainingSeconds > 0 ? `${hours}h ${minutes}m` : 'Ended'

                // Update progress bar
                const totalDuration = 24 * 60 * 60 // 24 hours in seconds
                const elapsed = totalDuration - timeRemainingSeconds
                const progressPercent = active ? Math.min(100, (elapsed / totalDuration) * 100) : 0
                document.getElementById('periodProgress').style.width = progressPercent + '%'

                addToEventLog('‚úÖ Period status updated', 'success')

            } catch (error) {
                console.error('Error loading period status:', error)
                addToEventLog(`‚ùå Error loading period status: ${error.message}`, 'danger')
            }
        }

        // Check if user has reported
        async function checkUserReportStatus() {
            try {
                if (!contract || !userAddress) return

                const [hasReported, timestamp] = await contract.hasUserReported(userAddress)

                const reportStatusDiv = document.getElementById('reportStatus')
                if (hasReported) {
                    const reportTime = new Date(timestamp.toNumber() * 1000).toLocaleString()
                    reportStatusDiv.innerHTML = `
                        <div class="alert alert-info">
                            ‚úÖ You have already submitted a report for this period at ${reportTime}
                        </div>
                    `
                } else {
                    reportStatusDiv.innerHTML = `
                        <div class="alert alert-warning">
                            ‚è≥ You have not submitted a report for this period yet
                        </div>
                    `
                }

            } catch (error) {
                console.error('Error checking report status:', error)
            }
        }

        // Submit health report
        async function submitHealthReport() {
            try {
                const symptomScore = document.getElementById('symptomScore').value
                const exposureLevel = document.getElementById('exposureLevel').value

                if (!symptomScore || !exposureLevel) {
                    addToEventLog('‚ùå Please select both symptom score and exposure level', 'danger')
                    return
                }

                if (!contract || !signer) {
                    addToEventLog('‚ùå Please connect your wallet first', 'danger')
                    return
                }

                addToEventLog('üìù Submitting health report...', 'info')

                const tx = await contract.submitHealthReport(
                    parseInt(symptomScore),
                    parseInt(exposureLevel)
                )

                addToEventLog(`‚è≥ Transaction submitted: ${tx.hash}`, 'info')

                const receipt = await tx.wait()
                addToEventLog('‚úÖ Health report submitted successfully!', 'success')

                // Clear form
                document.getElementById('symptomScore').value = ''
                document.getElementById('exposureLevel').value = ''

                // Refresh status
                await loadPeriodStatus()
                await checkUserReportStatus()

            } catch (error) {
                console.error('Error submitting report:', error)
                addToEventLog(`‚ùå Error submitting report: ${error.message}`, 'danger')
            }
        }

        // Health Authority Functions
        async function startNewPeriod() {
            try {
                if (!isHealthAuthority) {
                    addToEventLog('‚ùå Only health authority can start new periods', 'danger')
                    return
                }

                addToEventLog('üöÄ Starting new period...', 'info')
                const tx = await contract.startNewPeriod()
                addToEventLog(`‚è≥ Transaction submitted: ${tx.hash}`, 'info')

                await tx.wait()
                addToEventLog('‚úÖ New period started successfully!', 'success')
                await loadPeriodStatus()

            } catch (error) {
                console.error('Error starting new period:', error)
                addToEventLog(`‚ùå Error starting new period: ${error.message}`, 'danger')
            }
        }

        async function analyzePeriod() {
            try {
                if (!isHealthAuthority) {
                    addToEventLog('‚ùå Only health authority can analyze periods', 'danger')
                    return
                }

                addToEventLog('üî¨ Analyzing period...', 'info')
                const tx = await contract.analyzePeriod()
                addToEventLog(`‚è≥ Transaction submitted: ${tx.hash}`, 'info')

                await tx.wait()
                addToEventLog('‚úÖ Period analysis initiated!', 'success')

            } catch (error) {
                console.error('Error analyzing period:', error)
                addToEventLog(`‚ùå Error analyzing period: ${error.message}`, 'danger')
            }
        }

        async function emergencyEndPeriod() {
            try {
                if (!isHealthAuthority) {
                    addToEventLog('‚ùå Only health authority can end periods', 'danger')
                    return
                }

                if (!confirm('Are you sure you want to emergency end the current period?')) {
                    return
                }

                addToEventLog('üö® Emergency ending period...', 'info')
                const tx = await contract.emergencyEndPeriod()
                addToEventLog(`‚è≥ Transaction submitted: ${tx.hash}`, 'info')

                await tx.wait()
                addToEventLog('‚úÖ Period ended successfully!', 'success')
                await loadPeriodStatus()

            } catch (error) {
                console.error('Error ending period:', error)
                addToEventLog(`‚ùå Error ending period: ${error.message}`, 'danger')
            }
        }

        async function authorizeReporter() {
            try {
                const address = document.getElementById('reporterAddress').value.trim()
                if (!ethers.utils.isAddress(address)) {
                    addToEventLog('‚ùå Please enter a valid Ethereum address', 'danger')
                    return
                }

                addToEventLog('üîì Authorizing reporter...', 'info')
                const tx = await contract.authorizeReporter(address)
                addToEventLog(`‚è≥ Transaction submitted: ${tx.hash}`, 'info')

                await tx.wait()
                addToEventLog(`‚úÖ Reporter ${address.substring(0, 10)}... authorized!`, 'success')
                document.getElementById('reporterAddress').value = ''

            } catch (error) {
                console.error('Error authorizing reporter:', error)
                addToEventLog(`‚ùå Error authorizing reporter: ${error.message}`, 'danger')
            }
        }

        async function revokeReporter() {
            try {
                const address = document.getElementById('reporterAddress').value.trim()
                if (!ethers.utils.isAddress(address)) {
                    addToEventLog('‚ùå Please enter a valid Ethereum address', 'danger')
                    return
                }

                addToEventLog('üîí Revoking reporter...', 'info')
                const tx = await contract.revokeReporter(address)
                addToEventLog(`‚è≥ Transaction submitted: ${tx.hash}`, 'info')

                await tx.wait()
                addToEventLog(`‚úÖ Reporter ${address.substring(0, 10)}... revoked!`, 'success')
                document.getElementById('reporterAddress').value = ''

            } catch (error) {
                console.error('Error revoking reporter:', error)
                addToEventLog(`‚ùå Error revoking reporter: ${error.message}`, 'danger')
            }
        }

        async function updateThresholds() {
            try {
                const symptomThreshold = document.getElementById('symptomThreshold').value
                const exposureThreshold = document.getElementById('exposureThreshold').value

                if (!symptomThreshold || !exposureThreshold) {
                    addToEventLog('‚ùå Please enter both thresholds', 'danger')
                    return
                }

                addToEventLog('‚öôÔ∏è Updating thresholds...', 'info')
                const tx = await contract.updateThresholds(
                    parseInt(symptomThreshold),
                    parseInt(exposureThreshold)
                )
                addToEventLog(`‚è≥ Transaction submitted: ${tx.hash}`, 'info')

                await tx.wait()
                addToEventLog('‚úÖ Thresholds updated successfully!', 'success')

            } catch (error) {
                console.error('Error updating thresholds:', error)
                addToEventLog(`‚ùå Error updating thresholds: ${error.message}`, 'danger')
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            try {
                contract.on('PeriodStarted', (period, startTime) => {
                    addToEventLog(`üöÄ New period started: #${period}`, 'success')
                    loadPeriodStatus()
                })

                contract.on('HealthReportSubmitted', (reporter, period) => {
                    addToEventLog(`üìù Health report submitted for period #${period}`, 'info')
                    loadPeriodStatus()
                })

                contract.on('PeriodAnalyzed', (period, symptomAlert, exposureAlert) => {
                    let message = `üî¨ Period #${period} analyzed`
                    if (symptomAlert || exposureAlert) {
                        message += ' - ALERTS TRIGGERED'
                        addToEventLog(message, 'warning')
                    } else {
                        message += ' - No alerts'
                        addToEventLog(message, 'success')
                    }
                })

                contract.on('AlertTriggered', (period, alertType, value) => {
                    addToEventLog(`üö® ALERT: ${alertType} in period #${period} (value: ${value})`, 'danger')
                })

                contract.on('ReporterAuthorized', (reporter) => {
                    addToEventLog(`üîì Reporter authorized: ${reporter.substring(0, 10)}...`, 'success')
                })

                contract.on('ReporterRevoked', (reporter) => {
                    addToEventLog(`üîí Reporter revoked: ${reporter.substring(0, 10)}...`, 'warning')
                })

                addToEventLog('üëÇ Event listeners set up', 'info')

            } catch (error) {
                console.error('Error setting up event listeners:', error)
            }
        }

        // Utility functions
        function addToEventLog(message, type = 'info') {
            const eventLog = document.getElementById('eventLog')
            const timestamp = new Date().toLocaleTimeString()
            const alertClass = `alert-${type}`

            const logEntry = document.createElement('div')
            logEntry.className = `alert ${alertClass}`
            logEntry.style.margin = '5px 0'
            logEntry.style.fontSize = '0.9rem'
            logEntry.innerHTML = `<strong>${timestamp}:</strong> ${message}`

            eventLog.appendChild(logEntry)
            eventLog.scrollTop = eventLog.scrollHeight
        }

        function clearEventLog() {
            document.getElementById('eventLog').innerHTML =
                '<p style="color: #666; font-style: italic;">Events will appear here...</p>'
        }

        function disconnectWallet() {
            signer = null
            userAddress = null
            isHealthAuthority = false
            contract = contract ? new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider) : null

            updateConnectionStatus(false)
            document.getElementById('authorityCard').style.display = 'none'
            addToEventLog('üîå Wallet disconnected', 'info')

            // Reset status displays
            document.getElementById('currentPeriod').textContent = '-'
            document.getElementById('periodActive').textContent = '-'
            document.getElementById('participantCount').textContent = '-'
            document.getElementById('timeRemaining').textContent = '-'
            document.getElementById('reportStatus').innerHTML = ''
        }

        // Setup demo mode for testing interface without MetaMask
        function setupDemoMode() {
            // Show demo data
            document.getElementById('currentPeriod').textContent = '1'
            document.getElementById('periodActive').textContent = '‚úÖ Yes (Demo)'
            document.getElementById('participantCount').textContent = '42'
            document.getElementById('timeRemaining').textContent = '18h 30m'
            document.getElementById('periodProgress').style.width = '25%'

            document.getElementById('reportStatus').innerHTML = `
                <div class="alert alert-info">
                    üß™ Demo Mode - Connect MetaMask for real functionality
                </div>
            `

            addToEventLog('üß™ Demo mode activated', 'info')
        }

        // Auto-refresh period status every 30 seconds
        setInterval(() => {
            if (contract && userAddress) {
                loadPeriodStatus()
            }
        }, 30000)

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init)
    </script>
</body>
</html>